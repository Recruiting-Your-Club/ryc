version: '3.8'

services:
  app:
    container_name: spring-api
    build: .
    expose:
      - "8080"
    environment:
      - TZ=Asia/Seoul
      # 문법: ${변수명} 또는 ${변수명:?에러메시지}
      - PROFILES=${PROFILES:?PROFILES environment variable is not set}
    volumes:
      # [핵심] Host에 있는 application.yml을 컨테이너 내부로 연결 (읽기 전용)
      # 호스트 경로: /home/ubuntu/config/application.yml
      # 컨테이너 경로: /app/config/application.yml (Spring Boot가 자동으로 읽는 경로)
      - /home/ubuntu/config/application.yml:/app/config/application.yml:ro
    restart: always

  nginx:
    container_name: nginx-proxy
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Nginx 설정 파일 마운트
      - ./nginx/conf.d:/etc/nginx/conf.d
      # SSL 인증서 (Host 경로 -> 컨테이너 경로)
      - /etc/letsencrypt:/etc/letsencrypt:ro
      # Certbot 챌린지 경로 공유
      - /var/www/certbot:/var/www/certbot
    depends_on:
      - app
    restart: always