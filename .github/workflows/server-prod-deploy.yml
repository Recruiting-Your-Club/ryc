name: Production Server Deploy

on:
  push:
    branches: [ "main" ]
    paths:
      - 'server/**'

jobs:
  deploy:
    runs-on: self-hosted
    
    environment: server-development

    env:
      PROFILES: prod

    steps:
      - name: Fix permissions
        run: |
          sudo chown -R $USER:$USER .

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout-cone-mode: false
          sparse-checkout: |
            server

      - name: Make application.yml
        working-directory: ./server
        env:
          APPLICATION_YML_CONTENT: ${{ secrets.APPLICATION_YML }}
        run: |
          mkdir -p ./config
          rm -rf ./config/application.yml
          echo "$APPLICATION_YML_CONTENT" > ./config/application.yml

      - name: Deploy with Docker Compose
        working-directory: ./server 
        run: |
          docker compose up -d --build

      - name: Clean up unused Docker images
        run: |
          docker image prune -f
